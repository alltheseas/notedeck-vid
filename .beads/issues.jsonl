{"id":"notedeck-vid-08v","title":"PR 2: macOS VideoToolbox decoder","description":"Squash macOS VideoToolbox commits into 1-2 commits. Depends on PR 1.","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-31T23:35:01.849251813-06:00","updated_at":"2025-12-31T23:35:01.849251813-06:00","dependencies":[{"issue_id":"notedeck-vid-08v","depends_on_id":"notedeck-vid-9mg","type":"blocks","created_at":"2025-12-31T23:35:07.6257464-06:00","created_by":"daemon"}]}
{"id":"notedeck-vid-0yu","title":"Drop stale frames before target on forward seeks","description":"Stale frame filter only drops frames after target (\u003e target + 2s). Never drops frames before target, so forward seeks can display older frames.\n\nFIX: For forward seeks, also drop frames with pts \u003c target.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-31T19:12:58.089182527-06:00","updated_at":"2025-12-31T19:15:02.940558029-06:00","closed_at":"2025-12-31T19:15:02.940558029-06:00"}
{"id":"notedeck-vid-10d","title":"Seek fails on long HTTP videos with connection error","description":"SYMPTOM:\nSeeking forward on an 18-minute HTTP video fails with:\n```\nSeek error: Internal data stream error. \ngst_base_src_loop(): .../GstSoupHTTPSrc:source:\nstreaming stopped, reason error (-5)\n```\n\nROOT CAUSE:\n- HTTP seek requires new range request to server\n- Server connection dropped during seek operation\n- GStreamer's souphttpsrc reports this as a data stream error\n\nPOTENTIAL FIXES:\n1. Retry seek automatically on transient errors\n2. Don't propagate as fatal error - reset state and let user retry\n3. Increase HTTP connection timeouts in souphttpsrc\n4. Add retry logic with exponential backoff\n\nWORKAROUND:\nUser can try seeking again - usually works on second attempt","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-31T18:58:00.122042077-06:00","updated_at":"2025-12-31T19:08:22.789911005-06:00","closed_at":"2025-12-31T19:08:22.789911005-06:00"}
{"id":"notedeck-vid-199","title":"Back button freeze: GStreamer Drop blocks UI","description":"CRITICAL: Hitting the back button freezes the entire app.\n\nSYMPTOM:\n- When navigating away from a video (hitting back button), the UI freezes\n- Even 100ms delay is noticeable and unacceptable\n\nROOT CAUSE (linux_video_gst.rs Drop impl):\nThe Drop was waiting for pipeline state change, blocking the UI thread.\n\nFIX APPLIED:\nFire-and-forget - just call set_state(Null) without waiting:\n```rust\nimpl Drop for GStreamerDecoder {\n    fn drop(\u0026mut self) {\n        // Fire and forget - don't block the UI thread at all\n        // GStreamer handles cleanup asynchronously\n        let _ = self.pipeline.set_state(gst::State::Null);\n    }\n}\n```\n\nSTATUS: Fix applied, pending test","status":"closed","priority":0,"issue_type":"bug","created_at":"2025-12-31T15:22:08.039476942-06:00","updated_at":"2025-12-31T18:56:34.462585447-06:00","closed_at":"2025-12-31T18:56:34.462585447-06:00"}
{"id":"notedeck-vid-1bo","title":"Fix flush() not draining remaining decoded frames","description":"HIGH: flush() never drains remaining decoded frames at linux_video.rs:1355\n\ndecode_frame(\u0026[], 0) early-returns when decode_data is empty and does not process pending DecoderEvents. This drops final frames and makes end-of-stream decoding unreliable.\n\nFIX: After feeding data and on flush, drain ALL pending DecoderEvents. Push all FrameReady to the queue (or return first and queue rest). Ensures frames aren't stranded.","status":"closed","priority":0,"issue_type":"bug","created_at":"2025-12-30T20:06:52.605526377-06:00","updated_at":"2025-12-30T20:23:16.274920486-06:00","closed_at":"2025-12-30T20:23:16.274920486-06:00"}
{"id":"notedeck-vid-1nm","title":"Add warning log when stale frame loop hits max iterations","description":"In linux_video_gst.rs, the stale frame discard loop could iterate many times before hitting max_stale_frames. Add a warning log when we actually hit the limit to help diagnose performance issues. Location: pull_decoded_frame() stale frame detection logic.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-31T19:33:46.906388177-06:00","updated_at":"2025-12-31T19:33:46.906388177-06:00"}
{"id":"notedeck-vid-1nu","title":"Support I420/YV12 formats in addition to NV12 in GStreamer appsink","description":"Currently appsink caps hardcode NV12 format only (linux_video_gst.rs:169). Some decoders may output I420/YV12 natively, requiring videoconvert to do unnecessary conversion.\n\nAllow multiple formats:\n```rust\n.format_list([\n    gst_video::VideoFormat::Nv12,\n    gst_video::VideoFormat::I420,\n])\n```\n\nWould need corresponding changes in sample_to_frame() to handle different plane layouts. Minor perf optimization - videoconvert handles this automatically for now.","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-31T04:20:36.700948365-06:00","updated_at":"2025-12-31T15:08:06.52533258-06:00","closed_at":"2025-12-31T15:08:06.52533258-06:00"}
{"id":"notedeck-vid-1rh","title":"Map decoded frame to extract NV12 pixels","description":"Use handle.dyn_picture().dyn_mappable_handle().read(\u0026mut buffer) to get NV12 data. Convert to CpuFrame with Y and UV planes. Test: buffer contains non-zero pixel data, frame renders correctly.","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-30T17:11:13.937597957-06:00","updated_at":"2025-12-30T17:25:02.465852675-06:00","closed_at":"2025-12-30T17:25:02.465852675-06:00","dependencies":[{"issue_id":"notedeck-vid-1rh","depends_on_id":"notedeck-vid-ubo","type":"blocks","created_at":"2025-12-30T17:11:25.060123449-06:00","created_by":"daemon"}]}
{"id":"notedeck-vid-1vl","title":"Fix to_native_handle() for VaapiVideoFrame - export/re-import DRM PRIME","description":"SYMPTOM:\nDecoder panics at decoder.rs:303 with:\n'Failed to export video frame to vaapi picture!: VaapiVideoFrame is already a native VA-API surface. Use surface() directly.'\n\nROOT CAUSE:\nVaapiVideoFrame::to_native_handle() returns an error because we can't clone/move the owned Surface\u003c()\u003e.\nBut VaapiPicture::new() expects to_native_handle() to return a NEW Surface it can own.\n\nFor GbmVideoFrame, this works because it exports the GBM buffer as DRM PRIME and imports it into a new VA-API Surface.\n\nFIX NEEDED:\nImplement to_native_handle() for VaapiVideoFrame to:\n1. Export surface as DRM PRIME via surface.export_prime()\n2. Create VaapiExternalBufferDescriptor (like GbmExternalBufferDescriptor)\n3. Import via display.create_surfaces() with the descriptor\n4. Return the new Surface\n\nREFERENCE:\n- GbmExternalBufferDescriptor in gbm_video_frame.rs:260-328\n- GbmVideoFrame::to_native_handle() in gbm_video_frame.rs:397-437\n- Uses ExternalBufferDescriptor trait with MEMORY_TYPE = DrmPrime2\n\nKEY TYPES NEEDED:\n- VaapiExternalBufferDescriptor struct holding exported FDs\n- impl ExternalBufferDescriptor for VaapiExternalBufferDescriptor  \n- Update MemDescriptor and NativeHandle types accordingly","status":"closed","priority":0,"issue_type":"bug","created_at":"2025-12-30T23:27:51.603448257-06:00","updated_at":"2025-12-30T23:34:10.403020425-06:00","closed_at":"2025-12-30T23:34:10.403020425-06:00"}
{"id":"notedeck-vid-2b1","title":"VideoSource::size() blocks until EOF defeating streaming","description":"HIGH: Progressive path loads full response into memory before setting total_size.\n\nISSUE (linux_video.rs:575-577, commit 3d74e65a):\n- VideoSource::size() waits on total_size value\n- MP4 header parsing blocks until download completes (EOF)\n- Defeats the purpose of progressive streaming\n\nOPEN QUESTIONS:\n- Should non-2xx HTTP responses be treated as hard failures?\n- Is streaming expected to work with chunked responses (no Content-Length)?\n- Is a known size required for MP4 parsing?\n\nFIX SUGGESTION:\n```rust\n// If size is unknown, consider a retry or partial header read:\nlet size = match source.size() {\n    Ok(s) if s \u003e 0 =\u003e s,\n    _ =\u003e {\n        // Wait for Content-Length with timeout\n        // Or use mp4::Mp4Reader::read_header with streaming-friendly approach\n    }\n};\n```\n\nAlternative: Allow MP4 parsing without knowing total size upfront (requires mp4 crate support).","status":"closed","priority":0,"issue_type":"bug","created_at":"2025-12-30T20:12:46.152353718-06:00","updated_at":"2025-12-31T03:02:50.53284707-06:00","closed_at":"2025-12-31T03:02:50.53284707-06:00"}
{"id":"notedeck-vid-2do","title":"Expose hardware acceleration status in decoder","description":"Currently we request VA-API hardware acceleration but don't verify it's actually being used. Query the GStreamer factory/element to verify VA-API is active and expose this status (e.g., via a is_hardware_accelerated() method or logging at init). Helps users diagnose performance issues.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-31T19:33:47.252352407-06:00","updated_at":"2025-12-31T19:33:47.252352407-06:00"}
{"id":"notedeck-vid-2pq","title":"Fix progressive streaming - MP4 demuxer blocking","description":"Streaming now works for fast-start MP4 files. Non-fast-start files (moov at end) require waiting for full download. Current test video is non-fast-start.","status":"closed","priority":0,"issue_type":"bug","created_at":"2025-12-30T18:22:59.426066371-06:00","updated_at":"2025-12-30T18:30:08.995510034-06:00","closed_at":"2025-12-30T18:30:08.995510034-06:00"}
{"id":"notedeck-vid-32f","title":"Clarify VaapiFramePool::allocate behavior on resize","description":"OPEN QUESTION - External review finding\n\nDoes VaapiFramePool::allocate() append to existing surfaces or replace them?\n\n**Concerns:**\n- If it appends: Repeated FormatChanged events could grow the pool unintentionally\n- If it replaces: We may be dropping in-flight frames when resizing\n\n**Action needed:**\n1. Review VaapiFramePool::resize() and allocate() in vaapi_video_frame.rs\n2. Document the expected behavior\n3. Add safeguards if needed (e.g., wait for in-flight frames before resize, cap pool size)\n\n**Current code:**\n- src/video_frame/vaapi_video_frame.rs - VaapiFramePool impl","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-31T00:48:04.451287806-06:00","updated_at":"2025-12-31T00:55:36.573041888-06:00","closed_at":"2025-12-31T00:55:36.573041888-06:00"}
{"id":"notedeck-vid-3du","title":"GStreamer: missing SNAP_BEFORE flag for backward seeks","description":"ISSUE: Seek flags are FLUSH | KEY_UNIT only. For backward seeks, GStreamer may snap to future keyframe and freeze until it arrives.\n\nFIX: Add SeekFlags::SNAP_BEFORE when position \u003c self.position for backward seeks.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-31T03:05:14.215051429-06:00","updated_at":"2025-12-31T03:09:18.963521742-06:00","closed_at":"2025-12-31T03:09:18.963521742-06:00"}
{"id":"notedeck-vid-47f","title":"PR 4: Linux GStreamer decoder","description":"Squash Linux GStreamer commits into 2-3 commits. EXCLUDE cros-codecs dead code. Depends on PR 1.","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-31T23:35:02.168756344-06:00","updated_at":"2025-12-31T23:35:02.168756344-06:00","dependencies":[{"issue_id":"notedeck-vid-47f","depends_on_id":"notedeck-vid-9mg","type":"blocks","created_at":"2025-12-31T23:35:07.669750258-06:00","created_by":"daemon"}]}
{"id":"notedeck-vid-4lr","title":"UV non-128 heuristic is misleading for valid content","description":"MEDIUM: UV \"non-128\" check can falsely flag healthy frames.\n\nISSUE (linux_video.rs:1093):\n- UV plane values naturally vary around 128\n- Checking != 128 will flag most valid frames as \"non-128\"\n- Misleading instrumentation output\n\nFIX: Either remove UV heuristic or use a different metric (e.g., variance from 128).","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-30T20:14:42.08540618-06:00","updated_at":"2025-12-30T20:21:32.235641165-06:00","closed_at":"2025-12-30T20:21:32.235641165-06:00"}
{"id":"notedeck-vid-52r","title":"Fix VAAPI decode error: sync picture operation failed","description":"SYMPTOM:\nDecoder no longer panics, but frames fail to decode with:\n'H264 decode error: DecoderError(while syncing picture - operation failed)'\n\nFirst frame (preview at 0ns) gets partial decode but then errors.\nAll subsequent frames fail.\n\nLIKELY CAUSE:\nThe to_native_handle() export/re-import creates a NEW surface that references\nthe same underlying buffer but has a different VASurfaceID. When vaapi tries\nto use this imported surface, it may conflict with the original surface.\n\nPOSSIBLE FIXES:\n1. Don't re-import - find way to share/borrow surface ID instead\n2. Ensure imported surface has correct parameters\n3. Check if we need to sync original surface before export\n4. Check layer/object parameters in VaapiExternalBufferDescriptor\n\nINVESTIGATION:\n- Look at error from vaSyncSurface in cros-codecs decoder\n- Compare with how GBM export/import works\n- May need to use different approach for VA-API native surfaces","status":"closed","priority":0,"issue_type":"bug","created_at":"2025-12-30T23:36:51.635710269-06:00","updated_at":"2025-12-31T00:26:36.448181324-06:00","closed_at":"2025-12-31T00:26:36.448181324-06:00"}
{"id":"notedeck-vid-598","title":"Avoid Handle::block_on in async context - use dedicated runtime","description":"MEDIUM: download_video used Handle::block_on on current runtime.\n\nISSUE (linux_video.rs, commit fbc549ec):\n- Handle::block_on in async contexts can panic or deadlock\n- Not safe to call from within async runtime\n\nFIX SUGGESTION:\n```rust\n// Replace Handle::block_on usage with dedicated Runtime in thread\nlet rt = tokio::runtime::Runtime::new()?;\nlet response = rt.block_on(http_req(url))?;\n```\n\nNOTE: This may have been addressed in later commits. Verify current code still uses Handle::block_on.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-30T20:12:46.245122325-06:00","updated_at":"2025-12-30T21:45:21.59632711-06:00","closed_at":"2025-12-30T21:45:21.59632711-06:00"}
{"id":"notedeck-vid-5jm","title":"Handle NotEnoughOutputBuffers as recoverable backpressure","description":"HIGH PRIORITY - External review finding\n\nNotEnoughOutputBuffers is treated as a fatal decode error, which defeats the new pool behavior. When the pool is exhausted, alloc_frame returns None, the decoder emits NotEnoughOutputBuffers, and we immediately fall back to placeholder instead of waiting for frames to return to the pool.\n\nWith pooled surfaces, this is expected backpressure and should be handled as a recoverable \"try again later\" path.\n\n**Affected code:**\n- crates/notedeck/src/media/linux_video.rs:1365\n- crates/notedeck/src/media/linux_video.rs:1436\n\n**Fix approach:**\nWhen NotEnoughOutputBuffers is returned:\n1. Don't treat as fatal error\n2. Wait/yield briefly for frames to return to pool\n3. Retry the decode operation\n4. Only fall back to placeholder after timeout/max retries","status":"closed","priority":0,"issue_type":"bug","created_at":"2025-12-31T00:47:33.227938-06:00","updated_at":"2025-12-31T00:55:36.560438966-06:00","closed_at":"2025-12-31T00:55:36.560438966-06:00"}
{"id":"notedeck-vid-693","title":"Validate plane sizes against stride*height to prevent gray/garbled output","description":"HIGH: Truncated plane sizes at linux_video.rs:1060\n\nIf mapped plane sizes are smaller than stride * height, code truncates silently and builds CpuFrame with undersized planes. Yields gray/garbled output or breaks downstream assumptions.\n\nFIX: If plane.len() \u003c expected, either pad with neutral values (128 for Y, 128 for UV) or treat as decode failure to trigger fallback. Don't emit corrupted frames.","status":"closed","priority":0,"issue_type":"bug","created_at":"2025-12-30T20:06:52.917351938-06:00","updated_at":"2025-12-30T20:24:28.91066146-06:00","closed_at":"2025-12-30T20:24:28.91066146-06:00"}
{"id":"notedeck-vid-7fl","title":"GStreamer: fast forward breaks video, loops to start","description":"SYMPTOM: Hitting fast forward sends video back to initial frame in a loop.\n\nLIKELY CAUSE: Seek forward may be hitting EOS or triggering loop_playback incorrectly. Need to investigate seek() and EOS handling.","status":"closed","priority":0,"issue_type":"bug","created_at":"2025-12-31T03:12:25.219829493-06:00","updated_at":"2025-12-31T03:43:26.638004159-06:00","closed_at":"2025-12-31T03:43:26.638004159-06:00"}
{"id":"notedeck-vid-7ly","title":"Drain all DecoderEvents after feeding data","description":"MEDIUM: Only one DecoderEvent processed after feeding data at linux_video.rs:1327\n\nAdditional ready frames remain queued until next call. If no subsequent decode occurs (short clip or EOS), those frames are never surfaced.\n\nFIX SUGGESTION (linux_video.rs:1327, 1355):\n```rust\nwhile let Some(event) = self.decoder.next_event() {\n    match event {\n        DecoderEvent::FrameReady(handle) =\u003e { /* push/return frame */ }\n        DecoderEvent::FormatChanged =\u003e { /* update coded dims/format */ }\n    }\n}\n```\n\nNOTE: This overlaps with notedeck-vid-1bo (flush not draining). Consider fixing both together.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-30T20:07:10.10342973-06:00","updated_at":"2025-12-30T20:23:16.284386109-06:00","closed_at":"2025-12-30T20:23:16.284386109-06:00"}
{"id":"notedeck-vid-7zm","title":"Test VAAPI video playback on Linux","description":"Once build succeeds, test video playback with VAAPI hardware acceleration.\n\nSYSTEM INFO:\n- Intel iHD driver available (vainfo shows VAProfileH264Main, etc.)\n- libva 1.14.0 installed\n- libva-dev installed\n\nTEST PLAN:\n- Play video in note carousel\n- Test mute/unmute\n- Test seek bar\n- Test fullscreen mode","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-30T14:41:03.982097325-06:00","updated_at":"2025-12-30T16:37:43.72551259-06:00","closed_at":"2025-12-30T16:37:43.72551259-06:00","dependencies":[{"issue_id":"notedeck-vid-7zm","depends_on_id":"notedeck-vid-slp","type":"blocks","created_at":"2025-12-30T14:41:13.268919626-06:00","created_by":"daemon"}]}
{"id":"notedeck-vid-8ch","title":"Implement VA-API native surface allocation (bypass GBM)","description":"Implementing VA-API native surface allocation (bypass GBM).\n\nSTATUS: Build successful. All code changes complete.\n\nIMPLEMENTED:\n1. VaapiVideoFrame - VA-API surface holder with direct allocation\n2. VaapiReadMapping - Uses vaDeriveImage for CPU read access\n3. VaapiFramePool - Pre-allocates surfaces with RAII recycling\n4. PooledVaapiFrame - Auto-returns to pool on drop\n5. H264VaapiDecoder - Fully wired to use VaapiFramePool\n6. FormatChanged handlers - Updated to use VaapiFramePool API\n\nKEY CHANGES:\n- vaapi_video_frame.rs: New file in cros-codecs\n- linux_video.rs: GBM completely removed, using VA-API native allocation\n- Frame pool uses vaCreateSurfaces with USAGE_HINT_DECODER\n- Surface mapping via Image::derive_from() (vaDeriveImage API)\n\nNEXT: Run test to verify video decoding works","status":"closed","priority":0,"issue_type":"feature","created_at":"2025-12-30T22:46:18.213606736-06:00","updated_at":"2025-12-30T23:19:13.447442332-06:00","closed_at":"2025-12-30T23:19:13.447442332-06:00"}
{"id":"notedeck-vid-8qh","title":"Clear seeking state on all error paths","description":"If seek_simple() fails before bus wait, seeking=true and seek_target remain set. Decoder gets stuck in seeking mode forever, skipping error/EOS handling.\n\nFIX: Clear seeking/seek_target on every error path in seek_internal().","status":"closed","priority":0,"issue_type":"bug","created_at":"2025-12-31T19:12:57.77330843-06:00","updated_at":"2025-12-31T19:15:02.937529544-06:00","closed_at":"2025-12-31T19:15:02.937529544-06:00"}
{"id":"notedeck-vid-9dg","title":"Extract actual frame rate from GStreamer caps instead of hardcoding 30fps","description":"Currently frame_rate is hardcoded to 30.0 in metadata (linux_video_gst.rs:299). Extract actual frame rate from GStreamer caps:\n\n```rust\nif let Some(framerate) = structure.get::\u003cgst::Fraction\u003e(\"framerate\").ok() {\n    let fps = framerate.numer() as f64 / framerate.denom() as f64;\n    metadata.frame_rate = fps as f32;\n}\n```\n\nImproves frame scheduling accuracy for 24fps movies, 60fps content, etc.","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-31T04:20:28.025209887-06:00","updated_at":"2025-12-31T15:10:30.604431155-06:00","closed_at":"2025-12-31T15:10:30.604431155-06:00"}
{"id":"notedeck-vid-9fr","title":"Add gstreamer-rs dependency (Linux-only)","description":"Add gstreamer-rs and gstreamer-video-rs as Linux-only dependencies in Cargo.toml using target-specific dependencies:\n\n```toml\n[target.'cfg(target_os = \"linux\")'.dependencies]\ngstreamer = \"0.23\"\ngstreamer-video = \"0.23\"\ngstreamer-app = \"0.23\"\n```\n\nThis keeps macOS and Android builds unaffected.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-31T02:19:46.584415405-06:00","updated_at":"2025-12-31T02:23:53.790769577-06:00","closed_at":"2025-12-31T02:23:53.790769577-06:00"}
{"id":"notedeck-vid-9ly","title":"http_stream_to_file: add status check and body size limit","description":"CRITICAL: network.rs http_stream_to_file bypasses body-size limit and never checks HTTP status.\n\nISSUE (network.rs:28-144, commit 4dd8688f):\n- Non-2xx responses (404/500) are streamed to disk unchecked\n- No max body size enforcement during streaming\n- DoS risk + corrupt temp file from error responses\n\nFIX SUGGESTION (network.rs:70, 113):\n```rust\n// After res is obtained\nif !res.status().is_success() {\n    return Err(HyperHttpError::Hyper(Box::new(\n        std::io::Error::new(std::io::ErrorKind::Other, format!(\"HTTP {}\", res.status()))\n    )));\n}\n\n// Enforce max size from Content-Length\nif let Some(len) = content_length {\n    if len \u003e MAX_VIDEO_BODY_BYTES as u64 {\n        return Err(HyperHttpError::BodyTooLarge);\n    }\n}\n\n// Track total written during streaming\nlet mut written: u64 = 0;\nif let Ok(chunk) = frame.into_data() {\n    written += chunk.len() as u64;\n    if written \u003e MAX_VIDEO_BODY_BYTES as u64 {\n        return Err(HyperHttpError::BodyTooLarge);\n    }\n}\n```","status":"closed","priority":0,"issue_type":"bug","created_at":"2025-12-30T20:12:28.326088924-06:00","updated_at":"2025-12-31T03:02:50.535018818-06:00","closed_at":"2025-12-31T03:02:50.535018818-06:00"}
{"id":"notedeck-vid-9mg","title":"PR 1: Core video infrastructure (base)","description":"Squash core video commits into 3-4 logical commits: infrastructure, controls UI, FFmpeg/audio, UI polish. This is the foundation all platforms need.","status":"in_progress","priority":0,"issue_type":"task","created_at":"2025-12-31T23:35:01.703093341-06:00","updated_at":"2025-12-31T23:35:43.744983411-06:00"}
{"id":"notedeck-vid-9q8","title":"PR 3: Android ExoPlayer decoder","description":"Squash Android ExoPlayer commits into 2-3 commits. Depends on PR 1.","status":"open","priority":0,"issue_type":"task","created_at":"2025-12-31T23:35:01.997522714-06:00","updated_at":"2025-12-31T23:35:01.997522714-06:00","dependencies":[{"issue_id":"notedeck-vid-9q8","depends_on_id":"notedeck-vid-9mg","type":"blocks","created_at":"2025-12-31T23:35:07.647781349-06:00","created_by":"daemon"}]}
{"id":"notedeck-vid-ayh","title":"Remove cros-codecs Linux implementation","description":"DEFERRED: Remove cros-codecs Linux implementation once GStreamer is fully validated in production. Keep as fallback for now.","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-31T02:20:20.361186904-06:00","updated_at":"2025-12-31T03:57:48.590026908-06:00","closed_at":"2025-12-31T03:57:48.590026908-06:00","dependencies":[{"issue_id":"notedeck-vid-ayh","depends_on_id":"notedeck-vid-l08","type":"blocks","created_at":"2025-12-31T02:20:29.567369822-06:00","created_by":"daemon"}]}
{"id":"notedeck-vid-b1a","title":"GStreamer: Drop timeout too short, causes critical warnings","description":"ISSUE: 1s wait in Drop is too short. Pipeline may not reach NULL before drop, causing GStreamer critical warnings about destroying elements still running.\n\nFIX: Increase timeout to 5s in Drop impl.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-31T03:05:14.897914396-06:00","updated_at":"2025-12-31T03:09:18.966658003-06:00","closed_at":"2025-12-31T03:09:18.966658003-06:00"}
{"id":"notedeck-vid-b57","title":"GStreamer: increase or make configurable the AsyncDone timeout for metadata","description":"In GStreamerDecoder::new() (linux_video_gst.rs:237-262), we wait up to 10 seconds for AsyncDone to get video metadata. For large files or slow networks, this could timeout before the pipeline is ready.\n\nConsider:\n- Increasing timeout to 30 seconds\n- Making timeout configurable\n- Adding better error message when timeout occurs\n\nThis would improve reliability for users on slow connections.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-31T04:20:44.765303452-06:00","updated_at":"2025-12-31T15:10:30.739748319-06:00","closed_at":"2025-12-31T15:10:30.739748319-06:00"}
{"id":"notedeck-vid-bvs","title":"GStreamer: appsink not flushed on seek","description":"ISSUE: Appsink buffering isn't constrained or flushed on seek. Old samples may remain queued, causing stalls on backward seeks.\n\nFIX: Set appsink max-buffers=1, drop=true. Flush appsink after seek_simple().","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-31T03:05:14.382901649-06:00","updated_at":"2025-12-31T03:09:18.96507161-06:00","closed_at":"2025-12-31T03:09:18.96507161-06:00"}
{"id":"notedeck-vid-cfj","title":"Fix matroska-demuxer API usage in linux_video.rs","description":"The matroska-demuxer 0.5 API changed:\n- next_frame(\u0026mut self, frame: \u0026mut Frame) -\u003e Result\u003cbool\u003e\n- Previously: next_frame() -\u003e Result\u003cOption\u003cFrame\u003e\u003e\n\nNeed to update demuxer usage in linux_video.rs to match new API.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-30T15:47:33.222319444-06:00","updated_at":"2025-12-30T16:41:28.442340181-06:00","closed_at":"2025-12-30T16:41:28.442340181-06:00"}
{"id":"notedeck-vid-cft","title":"Pre-allocate VAAPI frame pool before first decode","description":"MEDIUM PRIORITY - External review finding\n\nThe pool is never allocated during init; it only allocates on FormatChanged. If FormatChanged doesn't fire (or is delayed), the pool stays empty and get_frame() fails for every decode, making VAAPI unusable for some streams even though width/height are already known.\n\n**Affected code:**\n- crates/notedeck/src/media/linux_video.rs:1745 (pool creation)\n- crates/notedeck/src/media/linux_video.rs:1308 (FormatChanged handler)\n\n**Fix approach:**\nConsider allocating at least one frame right after VaapiFramePool::new or before the first decode() call, using the dimensions from MP4 metadata.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-31T00:47:44.585664317-06:00","updated_at":"2025-12-31T00:55:36.57005744-06:00","closed_at":"2025-12-31T00:55:36.57005744-06:00"}
{"id":"notedeck-vid-czh","title":"Fix VAAPI frame allocation - decoder receives proper GbmVideoFrame","description":"VAAPI frame allocation issue diagnosed. Multiple bugs found in decode loop:\n\nROOT CAUSES IDENTIFIED:\n1. Infinite loop when decode() returns Ok(0) - decode_offset never advances\n2. flush() doesn't drain pending DecoderEvents - drops final frames\n3. Plane sizes not validated - truncation causes gray/garbled output\n4. GBM usage may not be CPU-mappable - map() fails silently\n5. NV12 format assumed without validation\n6. Only one event processed after decode - frames stuck in queue\n\nSee child issues for individual fixes.","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-30T18:06:09.848496473-06:00","updated_at":"2025-12-30T20:24:44.717437083-06:00","closed_at":"2025-12-30T20:24:44.717437083-06:00","dependencies":[{"issue_id":"notedeck-vid-czh","depends_on_id":"notedeck-vid-2pq","type":"blocks","created_at":"2025-12-30T18:23:04.758461846-06:00","created_by":"daemon"},{"issue_id":"notedeck-vid-czh","depends_on_id":"notedeck-vid-vr9","type":"blocks","created_at":"2025-12-30T20:07:33.137461796-06:00","created_by":"daemon"},{"issue_id":"notedeck-vid-czh","depends_on_id":"notedeck-vid-1bo","type":"blocks","created_at":"2025-12-30T20:07:33.173753795-06:00","created_by":"daemon"},{"issue_id":"notedeck-vid-czh","depends_on_id":"notedeck-vid-693","type":"blocks","created_at":"2025-12-30T20:07:33.206119868-06:00","created_by":"daemon"}]}
{"id":"notedeck-vid-d8n","title":"Fork/patch cros-codecs to use cros-libva 0.0.13","description":"FIXED cros-libva and cros-codecs AV1 encoding compatibility.\n\nPATCHES APPLIED:\n1. cros-libva-patched: Added #[cfg(libva_1_16_or_higher)] guards to all AV1 encoding types\n2. cros-codecs-patched: Commented out AV1 encoder module (requires libva \u003e= 1.16)\n\nBoth crates now compile with libva 1.14.0.\n\nNEW ISSUE: notedeck linux_video.rs has API mismatches with matroska-demuxer 0.5\n- next_frame() signature changed\n- Need to update demuxer usage","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-30T14:41:21.920775616-06:00","updated_at":"2025-12-30T15:53:59.332971528-06:00","closed_at":"2025-12-30T15:53:59.332971528-06:00"}
{"id":"notedeck-vid-d8t","title":"Add buffering UI feedback for network streams","description":"Add buffering UI feedback for network streams\n\nShow loading/buffering indicator when video is stalled waiting for network data. Currently video appears frozen when buffering, which users may interpret as a bug or crash.\n\nCURRENT STATE:\n- GStreamer now properly detects buffering percentage (0-100%)\n- Buffering state is tracked in decoder (buffering_percent field)\n- Large videos over HTTP can take 10+ seconds to buffer initially\n- No visual feedback to user during this time\n\nIMPLEMENTATION PLAN:\n1. Expose buffering state from decoder to VideoPlayer\n2. Add is_buffering() method to VideoDecoderBackend trait\n3. Show spinner/progress when buffering_percent \u003c 100\n4. Optionally show buffering percentage text\n\nNOTES:\n- Initial buffering should not pause pipeline (was_fully_buffered flag handles this)\n- Rebuffering during playback pauses pipeline until 100%\n- Consider showing buffering percentage vs just a spinner","status":"closed","priority":3,"issue_type":"feature","created_at":"2025-12-31T04:18:57.589353004-06:00","updated_at":"2025-12-31T06:37:53.81120106-06:00","closed_at":"2025-12-31T06:37:53.81120106-06:00"}
{"id":"notedeck-vid-dmz","title":"Scroll bar advances during buffering - timing desync","description":"CRITICAL: Scroll bar/position advances even when video/audio aren't playing.\n\nSYMPTOMS:\n- Hit play on video\n- Scroll bar starts moving immediately (within first frame)\n- Audio/video don't actually start for 3-5 seconds (buffering)\n- By the time video loops, position shows 10 seconds into a 6 second video\n- Complete desync between UI position and actual playback\n\nROOT CAUSE (frame_queue.rs FrameScheduler):\nThe scheduler uses wall-clock time, not frame PTS:\n```rust\npub fn start(\u0026mut self) {\n    self.playback_start_time = Some(std::time::Instant::now());  // Wall clock!\n    self.playback_start_position = self.current_position;\n}\n\npub fn position(\u0026self) -\u003e Duration {\n    match self.playback_start_time {\n        Some(start) =\u003e self.playback_start_position + start.elapsed(),  // Keeps advancing!\n        None =\u003e self.current_position,\n    }\n}\n```\n\nAnd in video_player.rs play():\n```rust\npub fn play(\u0026mut self) {\n    if let Some(ref thread) = self.decode_thread {\n        thread.play();\n        self.scheduler.start();  // Clock starts IMMEDIATELY\n        self.state = VideoState::Playing { position: self.scheduler.position() };\n    }\n}\n```\n\nThe scheduler clock starts on play(), but video may still be buffering. Position advances based on wall time, not actual frame delivery.\n\nFIX OPTIONS:\n1. Delay scheduler.start() until first frame arrives\n2. Drive position from frame PTS, not wall clock\n3. Pause scheduler when buffering, resume when frames flow\n4. Query GStreamer position directly instead of local clock\n\nRELATED:\n- buffering_percent initialized to 100 (wrong) - partially fixed\n- Buffering UI not appearing immediately","status":"closed","priority":0,"issue_type":"bug","created_at":"2025-12-31T15:22:23.980400163-06:00","updated_at":"2025-12-31T18:56:27.308966417-06:00","closed_at":"2025-12-31T18:56:27.308966417-06:00"}
{"id":"notedeck-vid-dn3","title":"Add network quality metrics logging","description":"For HTTP streams, log useful metrics like: estimated bandwidth, dropped frames count, rebuffer events, average buffer fill level. This telemetry helps diagnose playback issues on slow networks. Could be periodic (every 30s) or on-demand.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-31T19:33:47.978593247-06:00","updated_at":"2025-12-31T19:33:47.978593247-06:00"}
{"id":"notedeck-vid-dvb","title":"Implement actual VAAPI decoding with cros-codecs","description":"VAAPI decoding not yet implemented. Current state: demuxing works, placeholder frames shown. Both LinuxVaapiDecoder and FfmpegDecoder (without ffmpeg feature) show placeholders. For working video: either enable --features ffmpeg, or implement full VAAPI using cros-codecs StatelessDecoder with GbmVideoFrame and pixel extraction via map(). The test code in cros-codecs shows how to extract NV12 via dyn_picture().dyn_mappable_handle().read().","status":"closed","priority":0,"issue_type":"feature","created_at":"2025-12-30T17:02:35.331023632-06:00","updated_at":"2025-12-30T17:11:25.183113869-06:00","closed_at":"2025-12-30T17:11:25.183113869-06:00"}
{"id":"notedeck-vid-dwb","title":"Add audio playback support","description":"Video playback has no audio. Need to: 1) Demux audio track from container 2) Decode audio (AAC, etc) 3) Play audio with rodio or similar","status":"in_progress","priority":1,"issue_type":"feature","created_at":"2025-12-30T17:02:35.449066748-06:00","updated_at":"2025-12-31T03:03:14.089301848-06:00"}
{"id":"notedeck-vid-ela","title":"Change instrumentation info! to debug! in hot paths","description":"HIGH: Per-frame info! logging will flood logs and impact decode performance.\n\nISSUE (linux_video.rs:1031, 1235, 1275, 1404):\n- info! used in hot decode paths (runs every frame)\n- Will flood logs in production\n- Materially impacts decode performance\n\nFIX: Change info! to debug! or gate behind feature flag.","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-30T20:14:41.860833739-06:00","updated_at":"2025-12-30T20:21:32.225731961-06:00","closed_at":"2025-12-30T20:21:32.225731961-06:00"}
{"id":"notedeck-vid-ezk","title":"REQUIREMENTS: Development standards for Linux VAAPI work","description":"BUILD \u0026 DEVELOPMENT REQUIREMENTS for Linux VAAPI video player work:\n\n1. **All builds must use --release flag**\n   - --debug builds fail due to an unrelated bug\n   - Commands: cargo build --release, cargo run --release\n   - RUST_LOG=notedeck::media=debug cargo run --release\n\n2. **Global variables are NOT allowed**\n   - Even thread-local globals are prohibited\n   - State must be managed in structs passed as references\n\n3. **Inspect notedeck code for reusable components**\n   - Before creating new code, check existing patterns/elements\n   - Applies to both notedeck updates AND apps built on notedeck\n\n4. **Nevernesting**\n   - Favor early returns and guard clauses\n   - Avoid deeply nested conditionals\n   - Exit early instead of wrapping logic in multiple if layers\n\n5. **Do not fudge CI tests**\n   - Never hack tests to make CI pass\n   - Identify and fix the root cause of CI failures\n\n6. **Review nostrdb before proposing changes**\n   - Analyze if a nostrdb change/upgrade benefits the work\n   - Check nostrdb capabilities before implementing alternatives\n\n7. **Docstring coverage required**\n   - All added or modified code must have docstrings\n   - Document public APIs, complex logic, and non-obvious behavior\n\n8. **Run quality checks before commit**\n   - cargo fmt\n   - cargo clippy\n   - cargo test\n\n9. **Commits must be logically distinct and standalone**\n   - Each commit should represent one logical change\n   - Commits should be self-contained and independently reviewable\n   - Avoid mixing unrelated changes in a single commit","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-30T20:14:26.731552126-06:00","updated_at":"2025-12-31T03:26:28.166475934-06:00","closed_at":"2025-12-31T03:26:28.166475934-06:00"}
{"id":"notedeck-vid-g10","title":"GStreamer: premature EOS detection causes spurious video loop","description":"SYMPTOM:\n- Video jumps to beginning unexpectedly during playback\n- Especially after fast forward/seek operations\n- Log shows: 'EOS condition met: loop_playback=true' at wrong position\n\nROOT CAUSE:\n- EOS detection based on consecutive None results from decode_next (was 10, now 30)\n- After seek or during buffering, decode_next returns None while waiting\n- If too many Nones, EOS is falsely detected\n- With loop_playback=true (set by UI), video loops to start\n\nPARTIAL FIX APPLIED:\n- Increased threshold from 10 to 30 (~3 seconds)\n- Reset consecutive_none_count on Play command\n- Reset consecutive_none_count on Seek command\n\nREMAINING ISSUE:\n- HTTP streams with slow buffering may still trigger false EOS\n- Need smarter EOS detection (e.g., check actual GStreamer EOS message)\n\nLOCATION: crates/notedeck/src/media/frame_queue.rs decode_loop()","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-31T05:42:08.310176431-06:00","updated_at":"2025-12-31T05:50:08.466049165-06:00","closed_at":"2025-12-31T05:50:08.466049165-06:00"}
{"id":"notedeck-vid-hee","title":"Feed encoded samples to VAAPI decoder","description":"Call decoder.decode(timestamp, bitstream, alloc_cb) with demuxed H264 NAL units. The alloc_cb returns None for internal surface allocation. Test: decode() returns Ok without CheckEvents error.","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-30T17:11:13.637595789-06:00","updated_at":"2025-12-30T17:25:02.462395302-06:00","closed_at":"2025-12-30T17:25:02.462395302-06:00","dependencies":[{"issue_id":"notedeck-vid-hee","depends_on_id":"notedeck-vid-l93","type":"blocks","created_at":"2025-12-30T17:11:25.002593913-06:00","created_by":"daemon"}]}
{"id":"notedeck-vid-irp","title":"GStreamer: wire up UI mute/volume to GstAudioHandle","description":"Currently GStreamer plays audio directly via autoaudiosink, but the UI mute button doesn't control GStreamer's volume element. Need to pass GstAudioHandle from decoder through init channel and wire toggle_mute() to it.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-31T03:09:26.678472672-06:00","updated_at":"2025-12-31T03:42:48.905341519-06:00","closed_at":"2025-12-31T03:42:48.905341519-06:00"}
{"id":"notedeck-vid-kpf","title":"Implement buffering hysteresis (wait for 105% not 100%)","description":"Currently playback resumes immediately at 100% buffering. This can cause rapid buffer/unbuffer oscillation on marginal connections. Implement hysteresis: pause at low threshold (e.g., 10%), resume at high threshold (e.g., 105% or use time-based threshold like 2 seconds of buffer). Prevents rebuffering churn.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-31T19:33:49.029454341-06:00","updated_at":"2025-12-31T23:16:08.440869358-06:00","closed_at":"2025-12-31T23:16:08.440869358-06:00"}
{"id":"notedeck-vid-kqd","title":"ProgressiveReader::read needs timeout to prevent blocking forever","description":"HIGH: ProgressiveReader::read can block forever if download stalls.\n\nISSUE (linux_video.rs:265-282, commit 3d74e65a):\n- No timeout or abort path in read loop\n- Stalled download freezes demuxer thread and playback\n- No way to recover once stuck\n\nFIX SUGGESTION (linux_video.rs:265):\n```rust\nlet start = std::time::Instant::now();\nwhile self.downloader.bytes_downloaded() \u003c needed {\n    if self.downloader.is_complete() { break; }\n    if self.downloader.has_error() { return Err(io_err(\"Download failed\")); }\n    if start.elapsed() \u003e Duration::from_secs(30) {\n        return Err(io_err(\"Timeout waiting for data\"));\n    }\n    std::thread::sleep(Duration::from_millis(5));\n}\n```","status":"closed","priority":0,"issue_type":"bug","created_at":"2025-12-30T20:12:28.432405939-06:00","updated_at":"2025-12-30T20:27:40.439257037-06:00","closed_at":"2025-12-30T20:27:40.439257037-06:00"}
{"id":"notedeck-vid-l08","title":"Test GStreamer backend with problematic videos","description":"Test the GStreamer backend with videos that failed with cros-codecs:\n\n1. Videos with frame_num gaps\n2. Network streams with packet loss\n3. Various H.264 profiles (Baseline, Main, High)\n4. Different resolutions and framerates\n5. VP8/VP9 videos (bonus: GStreamer handles these too)\n\nSuccess criteria: Smooth playback without shutters/freezes/artifacts on videos that failed before.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-31T02:20:12.517289317-06:00","updated_at":"2025-12-31T02:40:08.523830146-06:00","closed_at":"2025-12-31T02:40:08.523830146-06:00","dependencies":[{"issue_id":"notedeck-vid-l08","depends_on_id":"notedeck-vid-mqg","type":"blocks","created_at":"2025-12-31T02:20:29.551821024-06:00","created_by":"daemon"}]}
{"id":"notedeck-vid-l93","title":"Create H264 StatelessDecoder with VAAPI backend","description":"Use StatelessDecoder::\u003cH264, _\u003e::new_vaapi(display, BlockingMode::Blocking) to create decoder. Test: decoder creates without error for H264 codec. Depends on Display task.","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-30T17:11:13.512373642-06:00","updated_at":"2025-12-30T17:22:49.036897215-06:00","closed_at":"2025-12-30T17:22:49.036897215-06:00","dependencies":[{"issue_id":"notedeck-vid-l93","depends_on_id":"notedeck-vid-xsn","type":"blocks","created_at":"2025-12-30T17:11:24.978556563-06:00","created_by":"daemon"}]}
{"id":"notedeck-vid-mez","title":"Implement GBM frame pool to prevent buffer exhaustion","description":"CRITICAL: GBM cannot allocate NV12 on Intel iHD - need VA-API native surfaces.\n\nCONFIRMED FINDINGS (Dec 31):\n1. iHD driver: VA-API init succeeds, but GBM cannot allocate NV12 (0/1 frames)\n2. i965 driver: Fails completely - not compatible with this GPU (Gen 12+)\n3. GBM-based allocation is a dead end for Intel desktop Linux\n\nERROR LOGS:\n- iHD: 'Error allocating contiguous buffer! Fourcc: NV12 width: 400 height: 720'\n- i965: '/usr/lib/x86_64-linux-gnu/dri/i965_drv_video.so init failed'\n\nROOT CAUSE:\n- cros-codecs uses GBM allocation -\u003e import to VA-API pattern\n- This works on ChromeOS but fails on desktop Linux with iHD\n- iHD requires VA-API to allocate its own surfaces with correct modifiers/tiling\n- GBM doesn't know what modifiers iHD needs for NV12\n\nSOLUTION REQUIRED - VA-API Native Surface Allocation:\n1. Create VaapiVideoFrame type that wraps VA-API allocated surfaces\n2. Use display.create_surfaces() WITHOUT external memory descriptors\n3. Let VA-API allocate surfaces directly (driver picks correct format/tiling)\n4. Export surfaces as DMA-BUF via vaExportSurfaceHandle for display\n5. Wire into decoder instead of PooledVideoFrame\u003cGbmVideoFrame\u003e\n\nREFERENCE:\n- VaSurfacePool in cros-codecs (surface_pool.rs) already does this for encoder\n- Need similar pattern for decoder output frames\n\nIMPLEMENTED SO FAR:\n- Fallible FramePool with ResizeResult (works but GBM fails)\n- Diagnostic logging (permissions, driver name)\n- Reduced pool size testing (confirmed 0/1 allocation)\n\nSTATUS: Blocked on architectural change to bypass GBM","status":"closed","priority":0,"issue_type":"bug","created_at":"2025-12-30T21:41:07.658227441-06:00","updated_at":"2025-12-30T22:46:25.517507873-06:00","closed_at":"2025-12-30T22:46:25.517507873-06:00"}
{"id":"notedeck-vid-mqg","title":"Integrate GStreamer backend with existing video infrastructure","description":"Wire GStreamer backend into the existing video player infrastructure:\n\n1. In mod.rs, use cfg(target_os = \"linux\") to select GStreamer backend\n2. Keep VideoDecoderBackend trait interface unchanged\n3. Ensure VideoFrame/DecodedFrame types work with GStreamer output\n4. Handle GStreamer initialization (gst::init()) at app startup\n5. Ensure proper cleanup on drop\n\nThe macOS (AVFoundation) and Android (MediaCodec) backends remain untouched.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-31T02:20:05.082410131-06:00","updated_at":"2025-12-31T02:32:23.102201422-06:00","closed_at":"2025-12-31T02:32:23.102201422-06:00","dependencies":[{"issue_id":"notedeck-vid-mqg","depends_on_id":"notedeck-vid-s4j","type":"blocks","created_at":"2025-12-31T02:20:29.526705606-06:00","created_by":"daemon"}]}
{"id":"notedeck-vid-nn6","title":"Treat seek timeout as failure not success","description":"If timed_pop_filtered returns None (timeout), code still updates position, clears eof, resets buffering. Marks seek done when it isn't.\n\nFIX: Return error on timeout instead of proceeding.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-31T19:12:57.929330357-06:00","updated_at":"2025-12-31T19:15:02.939098734-06:00","closed_at":"2025-12-31T19:15:02.939098734-06:00"}
{"id":"notedeck-vid-prd","title":"GStreamer: seek backward freezes video","description":"Clicking the progress bar dot to seek backward causes video to freeze. Fast forward works fine.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-31T02:40:08.816026366-06:00","updated_at":"2025-12-31T02:58:22.56704608-06:00","closed_at":"2025-12-31T02:58:22.56704608-06:00"}
{"id":"notedeck-vid-qed","title":"Epic: Replace Linux video with GStreamer-rs","description":"Replace the cros-codecs/VA-API Linux video implementation with GStreamer-rs. GStreamer handles H.264 edge cases (frame_num gaps, broken streams) that cros-codecs struggles with. Leave macOS and Android implementations untouched.","status":"closed","priority":0,"issue_type":"feature","created_at":"2025-12-31T02:19:38.314274243-06:00","updated_at":"2025-12-31T02:58:29.41071493-06:00","closed_at":"2025-12-31T02:58:29.41071493-06:00"}
{"id":"notedeck-vid-qy2","title":"Add MAX_PULL_ATTEMPTS to outer decode loop","description":"In linux_video_gst.rs pull_decoded_frame(), the outer 'loop' has no max iteration count. While inner loops are bounded, the outer loop could theoretically run indefinitely. Add a MAX_PULL_ATTEMPTS constant (e.g., 100) and break with warning if exceeded. Defensive programming measure.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-31T19:33:47.064734678-06:00","updated_at":"2025-12-31T19:33:47.064734678-06:00"}
{"id":"notedeck-vid-r6n","title":"Implement progressive video streaming for VAAPI","description":"Implement progressive HTTP download with streaming playback. Videos download to disk in background while playback starts immediately with available data. Requires: 1) Async downloader writing to file 2) Demuxer reading from partial file 3) Buffer underrun handling","status":"closed","priority":0,"issue_type":"feature","created_at":"2025-12-30T16:40:55.736720388-06:00","updated_at":"2025-12-30T16:52:31.133005668-06:00","closed_at":"2025-12-30T16:52:31.133005668-06:00"}
{"id":"notedeck-vid-rs2","title":"GStreamer: fullscreen shows double video","description":"When hitting fullscreen, video renders in both background and foreground simultaneously.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-31T02:40:08.668214106-06:00","updated_at":"2025-12-31T02:58:22.435857271-06:00","closed_at":"2025-12-31T02:58:22.435857271-06:00"}
{"id":"notedeck-vid-s4j","title":"Create GStreamer Linux video backend","description":"Create linux_video_gst.rs implementing VideoDecoderBackend trait using GStreamer:\n\n1. Create appsrc → decodebin → appsink pipeline\n2. Push encoded samples to appsrc\n3. Pull decoded frames from appsink\n4. Convert GStreamer VideoFrame to our VideoFrame format\n5. Handle seek via pipeline seeking\n\nKey GStreamer elements:\n- appsrc: feed encoded data\n- decodebin: auto-selects decoder (vaapih264dec, avdec_h264, etc.)\n- videoconvert: ensure NV12/I420 output\n- appsink: pull decoded frames\n\nPipeline: appsrc ! decodebin ! videoconvert ! appsink","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-31T02:19:56.946440696-06:00","updated_at":"2025-12-31T02:32:23.100184543-06:00","closed_at":"2025-12-31T02:32:23.100184543-06:00","dependencies":[{"issue_id":"notedeck-vid-s4j","depends_on_id":"notedeck-vid-9fr","type":"blocks","created_at":"2025-12-31T02:20:29.486778451-06:00","created_by":"daemon"}]}
{"id":"notedeck-vid-si0","title":"Use linear GBM usage for CPU-mappable buffers","description":"MEDIUM: GBM allocation uses GbmUsage::Decode only at linux_video.rs:1171\n\nIf driver picks tiled/opaque modifier, CPU mapping may fail or return unusable data. CrosVideoFrame::map() likely fails or returns empty planes.\n\nROOT CAUSE FOUND: NV12 is hardcoded as 'non-contiguous' in video_frame.rs:104. This causes allocation of separate R8 buffers per plane instead of a single NV12 buffer. VA-API export then fails because it requires contiguous memory.\n\nFIX: Remove NV12 from the non-contiguous match arm in cros-codecs-patched/src/video_frame.rs:104. The existing fallback from GBM_BO_USE_HW_VIDEO_DECODER to GBM_BO_USE_LINEAR (lines 549-567) should handle Intel iHD compatibility.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-30T20:07:09.396129897-06:00","updated_at":"2025-12-30T21:42:15.488319632-06:00","closed_at":"2025-12-30T21:42:15.488319632-06:00"}
{"id":"notedeck-vid-slp","title":"cros-libva API mismatch with system libva headers","description":"Build fails with cros-libva 0.0.12 (used by cros-codecs 0.0.6):\n\nERRORS:\n1. struct _VAEncPictureParameterBufferAV1 has no field 'refresh_frame_flags'\n2. new_bitfield_1() takes 15 args but 18 were supplied\n\nROOT CAUSE:\n- System has libva 1.14.0 (pkg-config --modversion libva)\n- cros-codecs 0.0.6 depends on cros-libva = '0.0.12' (exact version)\n- cros-libva 0.0.12 bindings generated for different libva version\n- Newer cros-libva 0.0.13 exists but cros-codecs pinned to 0.0.12\n\nATTEMPTED FIX:\n- Added patch in Cargo.toml: cros-libva = { git = '...', tag = 'v0.0.13' }\n- Patch NOT applied because cros-codecs requires exact '0.0.12'\n\nNEXT STEPS:\n1. Fork cros-codecs and update to cros-libva 0.0.13\n2. Or patch cros-codecs directly\n3. Or check if libva can be upgraded on system","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-30T14:35:31.520188461-06:00","updated_at":"2025-12-30T15:53:59.449606697-06:00","closed_at":"2025-12-30T15:53:59.449606697-06:00","dependencies":[{"issue_id":"notedeck-vid-slp","depends_on_id":"notedeck-vid-d8n","type":"blocks","created_at":"2025-12-30T14:41:28.398991883-06:00","created_by":"daemon"}]}
{"id":"notedeck-vid-sqs","title":"GStreamer: preview frame not loading for HTTP streams","description":"SYMPTOM:\n- Video thumbnail/preview shows black screen with play button\n- Duration shows correctly (metadata loaded) but no preview image\n- Log shows: 'No preview frame available after 30 attempts'\n\nROOT CAUSE (FIXED):\n- Preroll sample was consumed in constructor for dimensions but not cached\n- decode_next() had no frame to return when called for preview\n- With pipeline in Paused state, no new frames produced\n\nFIX APPLIED:\n- Cache preroll_sample in GStreamerDecoder struct\n- Return cached sample on first decode_next() call\n- Location: linux_video_gst.rs preroll_sample field\n\nTESTING NEEDED:\n- Verify preview frame now loads\n- Verify subsequent frames work after preroll consumed\n\nLOCATION: crates/notedeck/src/media/linux_video_gst.rs","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-31T05:42:18.393150846-06:00","updated_at":"2025-12-31T06:22:12.962806565-06:00","closed_at":"2025-12-31T06:22:12.962806565-06:00"}
{"id":"notedeck-vid-tgy","title":"Video player UX: known deficiencies summary","description":"SUMMARY OF KNOWN VIDEO PLAYER UX ISSUES:\n\n=== FIXED ===\n\n1. BACK BUTTON FREEZE (fixed)\n   - Was: GStreamer Drop blocked UI thread\n   - Fix: Fire-and-forget Drop, no blocking wait\n   - See: notedeck-vid-199 (closed)\n\n2. SCROLL BAR TIMING DESYNC (fixed)\n   - Was: Position advanced during buffering (showed 10s into 6s video)\n   - Fix: Scheduler clock only starts when first frame arrives\n   - See: notedeck-vid-dmz (closed)\n\n3. PREVIEW FRAME (fixed)\n   - Was: Black thumbnail until play pressed\n   - See: notedeck-vid-sqs (closed)\n\n4. BACKWARD SEEK (fixed)\n   - Was: 'every second backward seek works'\n   - See: notedeck-vid-w4r (closed)\n\n5. BUFFERING INDICATOR (fixed)\n   - Shows progress ring with percentage during buffering\n   - See: notedeck-vid-d8t (closed)\n\n6. FRAME RATE (fixed)\n   - Now extracted from GStreamer caps instead of hardcoded 30fps\n   - See: notedeck-vid-9dg (closed)\n\n=== NOT VIDEO-RELATED ===\n\n7. DOUBLE-CLICK BACK BUTTON\n   - See: notedeck-vid-yau (open)\n   - Confirmed NOT caused by video player\n   - Pre-existing notedeck_columns bug\n\n=== REMAINING ===\n\n- Choppy playback at start (intermittent, needs investigation)\n\nTESTING PROTOCOL:\n1. Play video - scroll bar should not advance during initial buffering\n2. Seek forward - buffering indicator should appear, scroll bar stays put\n3. At loop end - position should not exceed video duration\n4. Hit back button - should be instant (no freeze)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-31T05:42:29.63119407-06:00","updated_at":"2025-12-31T19:17:56.152555788-06:00","closed_at":"2025-12-31T19:17:56.152555788-06:00"}
{"id":"notedeck-vid-ubo","title":"Extract decoded frames via next_event()","description":"Poll decoder.next_event() for DecoderEvent::FrameReady(handle). Call handle.sync() to wait for decode. Test: FrameReady events received after feeding samples.","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-30T17:11:13.795517535-06:00","updated_at":"2025-12-30T17:25:02.464329077-06:00","closed_at":"2025-12-30T17:25:02.464329077-06:00","dependencies":[{"issue_id":"notedeck-vid-ubo","depends_on_id":"notedeck-vid-hee","type":"blocks","created_at":"2025-12-30T17:11:25.027861129-06:00","created_by":"daemon"}]}
{"id":"notedeck-vid-vh9","title":"GStreamer: bus contention during seek causes backward seek stall","description":"ISSUE: seek() waits for AsyncDone on bus while decode_next() also consumes bus messages via bus.pop(). Seek completion signal can be swallowed, pipeline remains in preroll/paused state with seeking=true.\n\nFIX: Gate bus polling in decode_next() while seeking flag is true. Use bus.timed_pop_filtered() in seek() to only consume ASYNC_DONE or ERROR.","status":"closed","priority":0,"issue_type":"bug","created_at":"2025-12-31T03:05:14.079335789-06:00","updated_at":"2025-12-31T03:09:18.961866807-06:00","closed_at":"2025-12-31T03:09:18.961866807-06:00"}
{"id":"notedeck-vid-vr9","title":"Fix infinite decode loop when decode() returns Ok(0)","description":"CRITICAL: Potential infinite decode loop at linux_video.rs:1269\n\nWhen decode() returns Ok(0), decode_attempts is reset to 0, but decode_offset never advances. The loop never terminates, manifesting as \"no frames ever shown.\"\n\nFIX: Treat Ok(0) as \"no progress\" - force an event drain or break. Don't reset decode_attempts to 0 on Ok(0).","status":"closed","priority":0,"issue_type":"bug","created_at":"2025-12-30T20:06:52.271927418-06:00","updated_at":"2025-12-30T20:11:50.049874663-06:00","closed_at":"2025-12-30T20:11:50.049874663-06:00"}
{"id":"notedeck-vid-vrw","title":"Remove Vec allocation in hot path plane sampling","description":"MEDIUM: Unnecessary Vec\u003cu8\u003e allocation twice per frame.\n\nISSUE (linux_video.rs:1072, 1091):\n- .collect() allocates Vec for plane sampling\n- Runs every frame\n\nFIX: Use iter().take(64).filter() directly without collect().","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-30T20:14:41.96905904-06:00","updated_at":"2025-12-30T20:21:32.233729832-06:00","closed_at":"2025-12-30T20:21:32.233729832-06:00"}
{"id":"notedeck-vid-w4r","title":"GStreamer: backward seek freeze with audio continuing","description":"Backward seek freeze - MOSTLY FIXED\n\nSYMPTOMS (original):\n- Every second backward seek froze video while audio continued\n- After multiple forward seeks, video would freeze indefinitely  \n- After multiple backward seeks, video looped to beginning unexpectedly\n\nROOT CAUSES FOUND:\n1. Stale frames in appsink after seek\n2. Frame queue race between flush() and decode thread receiving Seek\n3. False EOS detection via consecutive None counting\n4. GStreamer buffering messages not handled properly\n5. Pipeline state not managed during buffering/rebuffering\n\nFIXES APPLIED:\n1. Stale frame detection in decode_next() - discard frames with PTS \u003e seek_target + 2s\n2. Second flush() in decode loop after Seek command\n3. ACCURATE flag for backward seeks instead of KEY_UNIT+SNAP_BEFORE\n4. Replaced consecutive None counting with decoder.is_eof() check\n5. Added buffering_percent tracking from GStreamer Buffering messages\n6. Use longer timeout (1000ms) when buffering \u003c 100%\n7. Proper pipeline state management: PAUSED during rebuffering, PLAYING when 100%\n8. was_fully_buffered flag to distinguish initial buffering from rebuffering\n\nCURRENT STATUS:\n- One test video works perfectly with forward and backward seeks\n- Another video had 10s initial buffering delay (expected for large files)\n- Need more testing across different videos/network conditions\n\nFILES CHANGED:\n- linux_video_gst.rs: Buffering handling, stale frame detection, seek flags, is_eof()\n- frame_queue.rs: Second flush() on Seek, use decoder.is_eof() for EOS\n- video.rs: Added is_eof() to VideoDecoderBackend trait","status":"in_progress","priority":0,"issue_type":"bug","created_at":"2025-12-31T03:43:41.111529055-06:00","updated_at":"2025-12-31T06:22:13.094225548-06:00"}
{"id":"notedeck-vid-ws6","title":"Add instrumentation logging to VAAPI decoder","description":"Add minimal instrumentation to diagnose VAAPI decoder issues:\n\n1. Log when DecoderEvent::FrameReady fires: timestamp, display_resolution, stream_info.format, planes.len() after mapping\n2. Log CrosVideoFrame::map() failure with GBM buffer info (fourcc, modifier, GbmUsage)\n3. Log plane[i].len() vs expected_len (pitch * height) for Y/UV - warn if len \u003c expected\n4. Log number of events drained in CheckEvents loop and after decode\n5. Log decode() return bytes_decoded and decode_offset each iteration - warn on Ok(0)\n\nThis instrumentation will confirm:\n- If frames are arriving and mapping returns usable planes\n- Whether mapping fails due to usage/modifier/format\n- Stride/pitch mismatches\n- If frames are stuck in queue\n- The infinite loop risk from Ok(0)","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-30T20:07:21.80652033-06:00","updated_at":"2025-12-30T20:11:50.019605933-06:00","closed_at":"2025-12-30T20:11:50.019605933-06:00"}
{"id":"notedeck-vid-x3q","title":"Validate output format instead of assuming NV12","description":"MEDIUM: Output format assumed NV12 at linux_video.rs:1183, 1240\n\nstream_info.format is logged but not validated. If VAAPI outputs P010/I420, mapping/stride math is wrong and frames appear gray.\n\nFIX: When FormatChanged arrives, validate format is NV12. If not, either reject with clear error or add conversion. Record actual format and map accordingly.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-30T20:07:09.719214863-06:00","updated_at":"2025-12-31T03:02:50.53694506-06:00","closed_at":"2025-12-31T03:02:50.53694506-06:00"}
{"id":"notedeck-vid-xsn","title":"Open libva Display from DRM render node","description":"Use libva::Display::open() or open_drm_display() to create VAAPI display. Test: vainfo works, display opens without error. File: linux_video.rs init_vaapi_decoder()","status":"closed","priority":0,"issue_type":"task","created_at":"2025-12-30T17:11:13.375348347-06:00","updated_at":"2025-12-30T17:22:49.035147233-06:00","closed_at":"2025-12-30T17:22:49.035147233-06:00"}
{"id":"notedeck-vid-yau","title":"Double-click required for back button navigation","description":"SYMPTOM:\n- Back arrow button requires two clicks to navigate away from note view\n- Happens in note view regardless of video presence\n- First click does nothing, second click works\n\nINVESTIGATION RESULTS:\n- NOT caused by video player click capturing (tested with Sense::hover())\n- NOT caused by seek bar drag focus (tested with surrender_focus())\n- Issue exists in note view itself, independent of video code\n\nCONCLUSION:\nThis is a pre-existing notedeck_columns bug, NOT related to video work.\nShould be moved out of notedeck-vid scope.\n\nNEXT STEPS:\n- Investigate notedeck_columns/src/ui/column/header.rs back button handling\n- Check if issue exists on notes WITHOUT any media\n- Look for egui interaction state issues in note view rendering","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-31T15:27:41.662442209-06:00","updated_at":"2025-12-31T19:17:22.532657888-06:00","closed_at":"2025-12-31T19:17:22.532657888-06:00"}
